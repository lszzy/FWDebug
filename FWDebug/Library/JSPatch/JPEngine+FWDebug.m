//
//  JPEngine+FWDebug.m
//  FWDebug
//
//  Created by wuyong on 17/3/9.
//  Copyright © 2017年 ocphp.com. All rights reserved.
//

#import "JPEngine+FWDebug.h"
#import <UIKit/UIKit.h>

@implementation JPEngine (FWDebug)

+ (void)fwDebugLoad
{
    // 错误处理，弹框提示，不崩溃
    [JPEngine handleException:^(NSString *msg) {
        [[[UIAlertView alloc] initWithTitle:@"JSPatch Error" message:msg delegate:nil cancelButtonTitle:@"OK" otherButtonTitles:nil] show];
    }];
    
    [JPEngine startEngine];
    
    // 执行脚本
    NSString *scriptPath = [self fwDebugScriptPath];
    if ([[NSFileManager defaultManager] fileExistsAtPath:scriptPath]) {
        [JPEngine evaluateScriptWithPath:scriptPath];
    }
}

+ (NSString *)fwDebugScriptPath
{
    NSString *scriptFile = [[[self fwDebugBundlePath] stringByAppendingPathComponent:@"JSPatch"] stringByAppendingPathComponent:@"main.js"];
    return scriptFile;
}

+ (NSString *)fwDebugBundlePath
{
    static NSString *bundlePath = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        bundlePath = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) firstObject];
        bundlePath = [[bundlePath stringByAppendingPathComponent:@"FWDebug"] stringByAppendingPathComponent:@"JSPatch"];
        if (![[NSFileManager defaultManager] fileExistsAtPath:bundlePath]) {
            [[NSFileManager defaultManager] createDirectoryAtPath:bundlePath withIntermediateDirectories:YES attributes:nil error:NULL];
            
            // 自动解码文件
            [self bundleDecode:bundlePath];
        }
    });
    return bundlePath;
}

+ (void)bundleEncode
{
    NSString *fileName = @"JSPatch.js";
    NSString *filePath = [[NSBundle bundleForClass:[self class]] pathForResource:fileName ofType:nil];
    NSData *fileData = [NSData dataWithContentsOfFile:filePath];
    NSString *fileStr = [fileData base64EncodedStringWithOptions:0];
    
    NSString *savePath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) firstObject];
    savePath = [savePath stringByAppendingPathComponent:[fileName lastPathComponent]];
    NSData *saveData = [fileStr dataUsingEncoding:NSUTF8StringEncoding];
    [[NSFileManager defaultManager] createFileAtPath:savePath contents:saveData attributes:nil];
}

+ (void)bundleDecode:(NSString *)bundlePath
{
    NSString *fileName = @"JSPatch.js";
    NSString *savePath = [bundlePath stringByAppendingPathComponent:fileName];
    if ([[NSFileManager defaultManager] fileExistsAtPath:savePath]) {
        return;
    }
    
    NSData *fileData = [[NSData alloc] initWithBase64EncodedString:[self bundleContent] options:0];
    [[NSFileManager defaultManager] createFileAtPath:savePath contents:fileData attributes:nil];
}

+ (NSString *)bundleContent
{
    static NSString *content = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        content = @"dmFyIGdsb2JhbCA9IHRoaXMKCjsoZnVuY3Rpb24oKSB7CgogIHZhciBfb2NDbHMgPSB7fTsKICB2YXIgX2pzQ2xzID0ge307CgogIHZhciBfZm9ybWF0T0NUb0pTID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09PSB1bmRlZmluZWQgfHwgb2JqID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmICh0eXBlb2Ygb2JqID09ICJvYmplY3QiKSB7CiAgICAgIGlmIChvYmouX19vYmopIHJldHVybiBvYmoKICAgICAgaWYgKG9iai5fX2lzTmlsKSByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICB2YXIgcmV0ID0gW10KICAgICAgb2JqLmZvckVhY2goZnVuY3Rpb24obykgewogICAgICAgIHJldC5wdXNoKF9mb3JtYXRPQ1RvSlMobykpCiAgICAgIH0pCiAgICAgIHJldHVybiByZXQKICAgIH0KICAgIGlmIChvYmogaW5zdGFuY2VvZiBGdW5jdGlvbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpCiAgICAgICAgICAgIHZhciBmb3JtYXRlZEFyZ3MgPSBfT0NfZm9ybWF0SlNUb09DKGFyZ3MpCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGFyZ3NbaV0gPT09IG51bGwgfHwgYXJnc1tpXSA9PT0gdW5kZWZpbmVkIHx8IGFyZ3NbaV0gPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBmb3JtYXRlZEFyZ3Muc3BsaWNlKGksIDEsIHVuZGVmaW5lZCkKICAgICAgICAgICAgfSBlbHNlIGlmIChhcmdzW2ldID09IG5zbnVsbCkgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRBcmdzLnNwbGljZShpLCAxLCBudWxsKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBfT0NfZm9ybWF0T0NUb0pTKG9iai5hcHBseShvYmosIGZvcm1hdGVkQXJncykpCiAgICAgIH0KICAgIH0KICAgIGlmIChvYmogaW5zdGFuY2VvZiBPYmplY3QpIHsKICAgICAgdmFyIHJldCA9IHt9CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICByZXRba2V5XSA9IF9mb3JtYXRPQ1RvSlMob2JqW2tleV0pCiAgICAgIH0KICAgICAgcmV0dXJuIHJldAogICAgfQogICAgcmV0dXJuIG9iagogIH0KICAKICB2YXIgX21ldGhvZEZ1bmMgPSBmdW5jdGlvbihpbnN0YW5jZSwgY2xzTmFtZSwgbWV0aG9kTmFtZSwgYXJncywgaXNTdXBlciwgaXNQZXJmb3JtU2VsZWN0b3IpIHsKICAgIHZhciBzZWxlY3Rvck5hbWUgPSBtZXRob2ROYW1lCiAgICBpZiAoIWlzUGVyZm9ybVNlbGVjdG9yKSB7CiAgICAgIG1ldGhvZE5hbWUgPSBtZXRob2ROYW1lLnJlcGxhY2UoL19fL2csICItIikKICAgICAgc2VsZWN0b3JOYW1lID0gbWV0aG9kTmFtZS5yZXBsYWNlKC9fL2csICI6IikucmVwbGFjZSgvLS9nLCAiXyIpCiAgICAgIHZhciBtYXJjaEFyciA9IHNlbGVjdG9yTmFtZS5tYXRjaCgvOi9nKQogICAgICB2YXIgbnVtT2ZBcmdzID0gbWFyY2hBcnIgPyBtYXJjaEFyci5sZW5ndGggOiAwCiAgICAgIGlmIChhcmdzLmxlbmd0aCA+IG51bU9mQXJncykgewogICAgICAgIHNlbGVjdG9yTmFtZSArPSAiOiIKICAgICAgfQogICAgfQogICAgdmFyIHJldCA9IGluc3RhbmNlID8gX09DX2NhbGxJKGluc3RhbmNlLCBzZWxlY3Rvck5hbWUsIGFyZ3MsIGlzU3VwZXIpOgogICAgICAgICAgICAgICAgICAgICAgICAgX09DX2NhbGxDKGNsc05hbWUsIHNlbGVjdG9yTmFtZSwgYXJncykKICAgIHJldHVybiBfZm9ybWF0T0NUb0pTKHJldCkKICB9CgogIHZhciBfY3VzdG9tTWV0aG9kcyA9IHsKICAgIF9fYzogZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgc2xmID0gdGhpcwoKICAgICAgaWYgKHNsZiBpbnN0YW5jZW9mIEJvb2xlYW4pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNsZlttZXRob2ROYW1lXSkgewogICAgICAgIHJldHVybiBzbGZbbWV0aG9kTmFtZV0uYmluZChzbGYpOwogICAgICB9CgogICAgICBpZiAoIXNsZi5fX29iaiAmJiAhc2xmLl9fY2xzTmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihzbGYgKyAnLicgKyBtZXRob2ROYW1lICsgJyBpcyB1bmRlZmluZWQnKQogICAgICB9CiAgICAgIGlmIChzbGYuX19pc1N1cGVyICYmIHNsZi5fX2Nsc05hbWUpIHsKICAgICAgICAgIHNsZi5fX2Nsc05hbWUgPSBfT0Nfc3VwZXJDbHNOYW1lKHNsZi5fX29iai5fX3JlYWxDbHNOYW1lID8gc2xmLl9fb2JqLl9fcmVhbENsc05hbWU6IHNsZi5fX2Nsc05hbWUpOwogICAgICB9CiAgICAgIHZhciBjbHNOYW1lID0gc2xmLl9fY2xzTmFtZQogICAgICBpZiAoY2xzTmFtZSAmJiBfb2NDbHNbY2xzTmFtZV0pIHsKICAgICAgICB2YXIgbWV0aG9kVHlwZSA9IHNsZi5fX29iaiA/ICdpbnN0TWV0aG9kcyc6ICdjbHNNZXRob2RzJwogICAgICAgIGlmIChfb2NDbHNbY2xzTmFtZV1bbWV0aG9kVHlwZV1bbWV0aG9kTmFtZV0pIHsKICAgICAgICAgIHNsZi5fX2lzU3VwZXIgPSAwOwogICAgICAgICAgcmV0dXJuIF9vY0Nsc1tjbHNOYW1lXVttZXRob2RUeXBlXVttZXRob2ROYW1lXS5iaW5kKHNsZikKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKQogICAgICAgIHJldHVybiBfbWV0aG9kRnVuYyhzbGYuX19vYmosIHNsZi5fX2Nsc05hbWUsIG1ldGhvZE5hbWUsIGFyZ3MsIHNsZi5fX2lzU3VwZXIpCiAgICAgIH0KICAgIH0sCgogICAgc3VwZXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2xmID0gdGhpcwogICAgICBpZiAoc2xmLl9fb2JqKSB7CiAgICAgICAgc2xmLl9fb2JqLl9fcmVhbENsc05hbWUgPSBzbGYuX19yZWFsQ2xzTmFtZTsKICAgICAgfQogICAgICByZXR1cm4ge19fb2JqOiBzbGYuX19vYmosIF9fY2xzTmFtZTogc2xmLl9fY2xzTmFtZSwgX19pc1N1cGVyOiAxfQogICAgfSwKCiAgICBwZXJmb3JtU2VsZWN0b3JJbk9DOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNsZiA9IHRoaXMKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpCiAgICAgIHJldHVybiB7X19pc1BlcmZvcm1Jbk9DOjEsIG9iajpzbGYuX19vYmosIGNsc05hbWU6c2xmLl9fY2xzTmFtZSwgc2VsOiBhcmdzWzBdLCBhcmdzOiBhcmdzWzFdLCBjYjogYXJnc1syXX0KICAgIH0sCgogICAgcGVyZm9ybVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNsZiA9IHRoaXMKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpCiAgICAgIHJldHVybiBfbWV0aG9kRnVuYyhzbGYuX19vYmosIHNsZi5fX2Nsc05hbWUsIGFyZ3NbMF0sIGFyZ3Muc3BsaWNlKDEpLCBzbGYuX19pc1N1cGVyLCB0cnVlKQogICAgfQogIH0KCiAgZm9yICh2YXIgbWV0aG9kIGluIF9jdXN0b21NZXRob2RzKSB7CiAgICBpZiAoX2N1c3RvbU1ldGhvZHMuaGFzT3duUHJvcGVydHkobWV0aG9kKSkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoT2JqZWN0LnByb3RvdHlwZSwgbWV0aG9kLCB7dmFsdWU6IF9jdXN0b21NZXRob2RzW21ldGhvZF0sIGNvbmZpZ3VyYWJsZTpmYWxzZSwgZW51bWVyYWJsZTogZmFsc2V9KQogICAgfQogIH0KCiAgdmFyIF9yZXF1aXJlID0gZnVuY3Rpb24oY2xzTmFtZSkgewogICAgaWYgKCFnbG9iYWxbY2xzTmFtZV0pIHsKICAgICAgZ2xvYmFsW2Nsc05hbWVdID0gewogICAgICAgIF9fY2xzTmFtZTogY2xzTmFtZQogICAgICB9CiAgICB9IAogICAgcmV0dXJuIGdsb2JhbFtjbHNOYW1lXQogIH0KCiAgZ2xvYmFsLnJlcXVpcmUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsYXN0UmVxdWlyZQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpICsrKSB7CiAgICAgIGFyZ3VtZW50c1tpXS5zcGxpdCgnLCcpLmZvckVhY2goZnVuY3Rpb24oY2xzTmFtZSkgewogICAgICAgIGxhc3RSZXF1aXJlID0gX3JlcXVpcmUoY2xzTmFtZS50cmltKCkpCiAgICAgIH0pCiAgICB9CiAgICByZXR1cm4gbGFzdFJlcXVpcmUKICB9CgogIHZhciBfZm9ybWF0RGVmaW5lTWV0aG9kcyA9IGZ1bmN0aW9uKG1ldGhvZHMsIG5ld01ldGhvZHMsIHJlYWxDbHNOYW1lKSB7CiAgICBmb3IgKHZhciBtZXRob2ROYW1lIGluIG1ldGhvZHMpIHsKICAgICAgaWYgKCEobWV0aG9kc1ttZXRob2ROYW1lXSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSkgcmV0dXJuOwogICAgICAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgb3JpZ2luTWV0aG9kID0gbWV0aG9kc1ttZXRob2ROYW1lXQogICAgICAgIG5ld01ldGhvZHNbbWV0aG9kTmFtZV0gPSBbb3JpZ2luTWV0aG9kLmxlbmd0aCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgYXJncyA9IF9mb3JtYXRPQ1RvSlMoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkKICAgICAgICAgICAgdmFyIGxhc3RTZWxmID0gZ2xvYmFsLnNlbGYKICAgICAgICAgICAgZ2xvYmFsLnNlbGYgPSBhcmdzWzBdCiAgICAgICAgICAgIGlmIChnbG9iYWwuc2VsZikgZ2xvYmFsLnNlbGYuX19yZWFsQ2xzTmFtZSA9IHJlYWxDbHNOYW1lCiAgICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsMSkKICAgICAgICAgICAgdmFyIHJldCA9IG9yaWdpbk1ldGhvZC5hcHBseShvcmlnaW5NZXRob2QsIGFyZ3MpCiAgICAgICAgICAgIGdsb2JhbC5zZWxmID0gbGFzdFNlbGYKICAgICAgICAgICAgcmV0dXJuIHJldAogICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIF9PQ19jYXRjaChlLm1lc3NhZ2UsIGUuc3RhY2spCiAgICAgICAgICB9CiAgICAgICAgfV0KICAgICAgfSkoKQogICAgfQogIH0KCiAgdmFyIF93cmFwTG9jYWxNZXRob2QgPSBmdW5jdGlvbihtZXRob2ROYW1lLCBmdW5jLCByZWFsQ2xzTmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGFzdFNlbGYgPSBnbG9iYWwuc2VsZgogICAgICBnbG9iYWwuc2VsZiA9IHRoaXMKICAgICAgdGhpcy5fX3JlYWxDbHNOYW1lID0gcmVhbENsc05hbWUKICAgICAgdmFyIHJldCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKQogICAgICBnbG9iYWwuc2VsZiA9IGxhc3RTZWxmCiAgICAgIHJldHVybiByZXQKICAgIH0KICB9CgogIHZhciBfc2V0dXBKU01ldGhvZCA9IGZ1bmN0aW9uKGNsYXNzTmFtZSwgbWV0aG9kcywgaXNJbnN0LCByZWFsQ2xzTmFtZSkgewogICAgZm9yICh2YXIgbmFtZSBpbiBtZXRob2RzKSB7CiAgICAgIHZhciBrZXkgPSBpc0luc3QgPyAnaW5zdE1ldGhvZHMnOiAnY2xzTWV0aG9kcycsCiAgICAgICAgICBmdW5jID0gbWV0aG9kc1tuYW1lXQogICAgICBfb2NDbHNbY2xhc3NOYW1lXVtrZXldW25hbWVdID0gX3dyYXBMb2NhbE1ldGhvZChuYW1lLCBmdW5jLCByZWFsQ2xzTmFtZSkKICAgIH0KICB9CgogIHZhciBfcHJvcGVydGllc0dldEZ1biA9IGZ1bmN0aW9uKG5hbWUpewogICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzbGYgPSB0aGlzOwogICAgICBpZiAoIXNsZi5fX29jUHJvcHMpIHsKICAgICAgICB2YXIgcHJvcHMgPSBfT0NfZ2V0Q3VzdG9tUHJvcHMoc2xmLl9fb2JqKQogICAgICAgIGlmICghcHJvcHMpIHsKICAgICAgICAgIHByb3BzID0ge30KICAgICAgICAgIF9PQ19zZXRDdXN0b21Qcm9wcyhzbGYuX19vYmosIHByb3BzKQogICAgICAgIH0KICAgICAgICBzbGYuX19vY1Byb3BzID0gcHJvcHM7CiAgICAgIH0KICAgICAgcmV0dXJuIHNsZi5fX29jUHJvcHNbbmFtZV07CiAgICB9OwogIH0KCiAgdmFyIF9wcm9wZXJ0aWVzU2V0RnVuID0gZnVuY3Rpb24obmFtZSl7CiAgICByZXR1cm4gZnVuY3Rpb24oanZhbCl7CiAgICAgIHZhciBzbGYgPSB0aGlzOwogICAgICBpZiAoIXNsZi5fX29jUHJvcHMpIHsKICAgICAgICB2YXIgcHJvcHMgPSBfT0NfZ2V0Q3VzdG9tUHJvcHMoc2xmLl9fb2JqKQogICAgICAgIGlmICghcHJvcHMpIHsKICAgICAgICAgIHByb3BzID0ge30KICAgICAgICAgIF9PQ19zZXRDdXN0b21Qcm9wcyhzbGYuX19vYmosIHByb3BzKQogICAgICAgIH0KICAgICAgICBzbGYuX19vY1Byb3BzID0gcHJvcHM7CiAgICAgIH0KICAgICAgc2xmLl9fb2NQcm9wc1tuYW1lXSA9IGp2YWw7CiAgICB9OwogIH0KCiAgZ2xvYmFsLmRlZmluZUNsYXNzID0gZnVuY3Rpb24oZGVjbGFyYXRpb24sIHByb3BlcnRpZXMsIGluc3RNZXRob2RzLCBjbHNNZXRob2RzKSB7CiAgICB2YXIgbmV3SW5zdE1ldGhvZHMgPSB7fSwgbmV3Q2xzTWV0aG9kcyA9IHt9CiAgICBpZiAoIShwcm9wZXJ0aWVzIGluc3RhbmNlb2YgQXJyYXkpKSB7CiAgICAgIGNsc01ldGhvZHMgPSBpbnN0TWV0aG9kcwogICAgICBpbnN0TWV0aG9kcyA9IHByb3BlcnRpZXMKICAgICAgcHJvcGVydGllcyA9IG51bGwKICAgIH0KCiAgICBpZiAocHJvcGVydGllcykgewogICAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24obmFtZSl7CiAgICAgICAgaWYgKCFpbnN0TWV0aG9kc1tuYW1lXSkgewogICAgICAgICAgaW5zdE1ldGhvZHNbbmFtZV0gPSBfcHJvcGVydGllc0dldEZ1bihuYW1lKTsKICAgICAgICB9CiAgICAgICAgdmFyIG5hbWVPZlNldCA9ICJzZXQiKyBuYW1lLnN1YnN0cigwLDEpLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnN1YnN0cigxKTsKICAgICAgICBpZiAoIWluc3RNZXRob2RzW25hbWVPZlNldF0pIHsKICAgICAgICAgIGluc3RNZXRob2RzW25hbWVPZlNldF0gPSBfcHJvcGVydGllc1NldEZ1bihuYW1lKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHZhciByZWFsQ2xzTmFtZSA9IGRlY2xhcmF0aW9uLnNwbGl0KCc6JylbMF0udHJpbSgpCgogICAgX2Zvcm1hdERlZmluZU1ldGhvZHMoaW5zdE1ldGhvZHMsIG5ld0luc3RNZXRob2RzLCByZWFsQ2xzTmFtZSkKICAgIF9mb3JtYXREZWZpbmVNZXRob2RzKGNsc01ldGhvZHMsIG5ld0Nsc01ldGhvZHMsIHJlYWxDbHNOYW1lKQoKICAgIHZhciByZXQgPSBfT0NfZGVmaW5lQ2xhc3MoZGVjbGFyYXRpb24sIG5ld0luc3RNZXRob2RzLCBuZXdDbHNNZXRob2RzKQogICAgdmFyIGNsYXNzTmFtZSA9IHJldFsnY2xzJ10KICAgIHZhciBzdXBlckNscyA9IHJldFsnc3VwZXJDbHMnXQoKICAgIF9vY0Nsc1tjbGFzc05hbWVdID0gewogICAgICBpbnN0TWV0aG9kczoge30sCiAgICAgIGNsc01ldGhvZHM6IHt9LAogICAgfQoKICAgIGlmIChzdXBlckNscy5sZW5ndGggJiYgX29jQ2xzW3N1cGVyQ2xzXSkgewogICAgICBmb3IgKHZhciBmdW5jTmFtZSBpbiBfb2NDbHNbc3VwZXJDbHNdWydpbnN0TWV0aG9kcyddKSB7CiAgICAgICAgX29jQ2xzW2NsYXNzTmFtZV1bJ2luc3RNZXRob2RzJ11bZnVuY05hbWVdID0gX29jQ2xzW3N1cGVyQ2xzXVsnaW5zdE1ldGhvZHMnXVtmdW5jTmFtZV0KICAgICAgfQogICAgICBmb3IgKHZhciBmdW5jTmFtZSBpbiBfb2NDbHNbc3VwZXJDbHNdWydjbHNNZXRob2RzJ10pIHsKICAgICAgICBfb2NDbHNbY2xhc3NOYW1lXVsnY2xzTWV0aG9kcyddW2Z1bmNOYW1lXSA9IF9vY0Nsc1tzdXBlckNsc11bJ2Nsc01ldGhvZHMnXVtmdW5jTmFtZV0KICAgICAgfQogICAgfQoKICAgIF9zZXR1cEpTTWV0aG9kKGNsYXNzTmFtZSwgaW5zdE1ldGhvZHMsIDEsIHJlYWxDbHNOYW1lKQogICAgX3NldHVwSlNNZXRob2QoY2xhc3NOYW1lLCBjbHNNZXRob2RzLCAwLCByZWFsQ2xzTmFtZSkKCiAgICByZXR1cm4gcmVxdWlyZShjbGFzc05hbWUpCiAgfQoKICBnbG9iYWwuZGVmaW5lUHJvdG9jb2wgPSBmdW5jdGlvbihkZWNsYXJhdGlvbiwgaW5zdFByb3RvcyAsIGNsc1Byb3RvcykgewogICAgICB2YXIgcmV0ID0gX09DX2RlZmluZVByb3RvY29sKGRlY2xhcmF0aW9uLCBpbnN0UHJvdG9zLGNsc1Byb3Rvcyk7CiAgICAgIHJldHVybiByZXQKICB9CgogIGdsb2JhbC5ibG9jayA9IGZ1bmN0aW9uKGFyZ3MsIGNiKSB7CiAgICB2YXIgdGhhdCA9IHRoaXMKICAgIHZhciBzbGYgPSBnbG9iYWwuc2VsZgogICAgaWYgKGFyZ3MgaW5zdGFuY2VvZiBGdW5jdGlvbikgewogICAgICBjYiA9IGFyZ3MKICAgICAgYXJncyA9ICcnCiAgICB9CiAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpCiAgICAgIGdsb2JhbC5zZWxmID0gc2xmCiAgICAgIHJldHVybiBjYi5hcHBseSh0aGF0LCBfZm9ybWF0T0NUb0pTKGFyZ3MpKQogICAgfQogICAgdmFyIHJldCA9IHthcmdzOiBhcmdzLCBjYjogY2FsbGJhY2ssIGFyZ0NvdW50OiBjYi5sZW5ndGgsIF9faXNCbG9jazogMX0KICAgIGlmIChnbG9iYWwuX19nZW5CbG9jaykgewogICAgICByZXRbJ2Jsb2NrT2JqJ10gPSBnbG9iYWwuX19nZW5CbG9jayhhcmdzLCBjYikKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgaWYgKGdsb2JhbC5jb25zb2xlKSB7CiAgICB2YXIganNMb2dnZXIgPSBjb25zb2xlLmxvZzsKICAgIGdsb2JhbC5jb25zb2xlLmxvZyA9IGZ1bmN0aW9uKCkgewogICAgICBnbG9iYWwuX09DX2xvZy5hcHBseShnbG9iYWwsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChqc0xvZ2dlcikgewogICAgICAgIGpzTG9nZ2VyLmFwcGx5KGdsb2JhbC5jb25zb2xlLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGdsb2JhbC5jb25zb2xlID0gewogICAgICBsb2c6IGdsb2JhbC5fT0NfbG9nCiAgICB9CiAgfQoKICBnbG9iYWwuZGVmaW5lSlNDbGFzcyA9IGZ1bmN0aW9uKGRlY2xhcmF0aW9uLCBpbnN0TWV0aG9kcywgY2xzTWV0aG9kcykgewogICAgdmFyIG8gPSBmdW5jdGlvbigpIHt9LAogICAgICAgIGEgPSBkZWNsYXJhdGlvbi5zcGxpdCgnOicpLAogICAgICAgIGNsc05hbWUgPSBhWzBdLnRyaW0oKSwKICAgICAgICBzdXBlckNsc05hbWUgPSBhWzFdID8gYVsxXS50cmltKCkgOiBudWxsCiAgICBvLnByb3RvdHlwZSA9IHsKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc3VwZXIoKSkgdGhpcy5zdXBlcigpLmluaXQoKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBzdXBlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN1cGVyQ2xzTmFtZSA/IF9qc0Nsc1tzdXBlckNsc05hbWVdLnByb3RvdHlwZSA6IG51bGwKICAgICAgfQogICAgfQogICAgdmFyIGNscyA9IHsKICAgICAgYWxsb2M6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgbzsKICAgICAgfQogICAgfQogICAgZm9yICh2YXIgbWV0aG9kTmFtZSBpbiBpbnN0TWV0aG9kcykgewogICAgICBvLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGluc3RNZXRob2RzW21ldGhvZE5hbWVdOwogICAgfQogICAgZm9yICh2YXIgbWV0aG9kTmFtZSBpbiBjbHNNZXRob2RzKSB7CiAgICAgIGNsc1ttZXRob2ROYW1lXSA9IGNsc01ldGhvZHNbbWV0aG9kTmFtZV07CiAgICB9CiAgICBnbG9iYWxbY2xzTmFtZV0gPSBjbHMKICAgIF9qc0Nsc1tjbHNOYW1lXSA9IG8KICB9CiAgCiAgZ2xvYmFsLllFUyA9IDEKICBnbG9iYWwuTk8gPSAwCiAgZ2xvYmFsLm5zbnVsbCA9IF9PQ19udWxsCiAgZ2xvYmFsLl9mb3JtYXRPQ1RvSlMgPSBfZm9ybWF0T0NUb0pTCiAgCn0pKCkK";
    });
    return content;
}

@end
